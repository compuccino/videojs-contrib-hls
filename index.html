<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>videojs-contrib-hls Demo</title>
  <link href="/node_modules/video.js/dist/video-js.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .info {
      background-color: #eee;
      border: thin solid #333;
      border-radius: 3px;
      padding: 0 5px;
      margin: 20px 0;
    }
    input {
      margin-top: 15px;
      min-width: 450px;
      padding: 5px;
    }
  </style>

</head>
<body>
  <div class="info">
    <p>The video below is an <a href="https://developer.apple.com/library/ios/documentation/networkinginternet/conceptual/streamingmediaguide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008332-CH1-SW1">HTTP Live Stream</a>. On desktop browsers other than Safari, the HLS plugin will polyfill support for the format on top of the video.js Flash tech.</p>
    <p>Due to security restrictions in Flash, you will have to load this page over HTTP(S) to see the example in action.</p>
  </div>
  <video id="videojs-contrib-hls-player" class="video-js vjs-default-skin" controls>
    <source src="https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8" type="application/x-mpegURL">
  </video>

  <form id=load-url>
    <label>
      Video URL:
      <input id=url type=url value="https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8">
    </label>
    <button type=submit>Load</button>
  </form>
  <ul>
    <li><a href="/test/">Run unit tests in browser.</a></li>
    <li><a href="/docs/api/">Read generated docs.</a></li>
    <li><a href="/examples">Browse Examples</a></li>
  </ul>

  Select variant playlist: <select id="quality-picker"></select>

  <p>
    Media attributes at playhead:
    <p><pre id="current-quality-attr">{}</pre></p>
  </p>

  <p>
    <ul>
      <li>Trace 0: Recommended BANDWIDTHs of playlists selected</li>
      <li>Trace 1: Effective bitrates of segments loaded</li>
    </ul>
    <div id="quality-graph"></div>
  </p>


  <script src="https://cdn.plot.ly/plotly-1.28.3.min.js"></script>
  <script src="/node_modules/jquery/dist/jquery.js"></script>
  <script src="/node_modules/video.js/dist/video.js"></script>
  <script src="/node_modules/videojs-contrib-quality-levels/dist/videojs-contrib-quality-levels.js"></script>
  <script src="/dist/videojs-contrib-hls.js"></script>
  <script>
    (function(window, videojs) {

      var videojsHlsDemo = {
        player: null,
        url: null,
        hlsHandler: null
      };

      var hlsOptions = {
        debug: true,
        smoothQualitySwitch: true,
        disableImmediateQualityChange: true
      };

      var playerOptions = {
        html5: {
          hls: hlsOptions
        }
      };

      var player = videojsHlsDemo.player = videojs('videojs-contrib-hls-player', playerOptions);

      // hook up the video switcher
      var loadUrl = document.getElementById('load-url');
      var url = document.getElementById('url');
      loadUrl.addEventListener('submit', function(event) {
        event.preventDefault();
        videojsHlsDemo.url = url.value;
        player.src({
          src: url.value,
          type: 'application/x-mpegURL'
        });
        return false;
      });

      window.videojsContribHlsDemo = videojsHlsDemo;

    }(window, window.videojs));
  </script>

  <script type="text/javascript">
    
      var videojsHlsDemo = window.videojsContribHlsDemo;
      var player = window.videojsContribHlsDemo.player;

      player.on('loadedmetadata', function() {

        videojsHlsDemo.hlsHandler = player.tech_.hls;

        $('#quality-picker')
          .append('<option value="-1">Auto</option>');

        var qualityLevels = player.qualityLevels()
        for (var i = 0; i < qualityLevels.length; i++) {
          var level = qualityLevels[i];
          var description = level.width + ' x ' + level.height + ' - (' + level.bitrate + ' [bits/sec])';
          $('#quality-picker')
            .append('<option value="' + i + '">' + description + '</option>');
        }

        $('#quality-picker').change(function(e) {
          // Disable ALL quality levels
          // Enable ONLY selected quality level
          var qualityLevels = player.qualityLevels()
          for (var i = 0; i < qualityLevels.length; i++) {
            var level = qualityLevels[i];
            if (i === Number(e.target.value) || i === -1) {
              level.enabled = true;
            } else {
              level.enabled = false;
            }
          }
        });

      });

      player.on('timeupdate', function() {
        var hlsHandler = videojsHlsDemo.hlsHandler;
        if (hlsHandler) {
          var attr = hlsHandler.findRepresentationAttributesAtBufferPosition(player.currentTime());
          if (attr) {
            $('#current-quality-attr').html(JSON.stringify(attr, null, 2));
          }
        }

      });

      setInterval(function() {

        var hlsHandler = videojsHlsDemo.hlsHandler;
        if (hlsHandler) {
          var bufferMap = hlsHandler.getMainBufferPayloadAttributesMap();

          var startTimes = bufferMap.map(function(entry) {
            return entry.startTime;
          });
          var bandwidths = bufferMap.map(function(entry) {
            return entry.representationAttributes['BANDWIDTH'];
          });
          var effectiveBitrates = bufferMap.map(function(entry) {
            return entry.effectiveBitrate;
          });

          var graphDiv = $('#quality-graph')[0];

          if (!videojsHlsDemo.isPlotInitialized) {
            Plotly.purge(graphDiv);
            Plotly.newPlot(
              graphDiv,
              [],
              {
                title: 'Buffer state',
                xaxis: {
                  title: 'Time [s]'
                },
                yaxis: {
                  title: 'Bitrate [b/s]',
                }
              }
            );
            videojsHlsDemo.isPlotInitialized = true;
          }

          videojsHlsDemo.isPlotFilled && Plotly.deleteTraces(graphDiv, 0);
          videojsHlsDemo.isPlotFilled && Plotly.deleteTraces(graphDiv, 0);
          Plotly.addTraces(
            graphDiv,
            [{
              x: startTimes,
              y: bandwidths
            },{
              x: startTimes,
              y: effectiveBitrates
            }]
          );
          videojsHlsDemo.isPlotFilled = true;
        }
      }, 1000);

  </script>
</body>
</html>
